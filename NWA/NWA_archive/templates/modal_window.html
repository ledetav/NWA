{% extends "base.html" %}
{% load static %}

{% block modal_block %}
<div class="modal js-modal"> <!-- Изначально скрыто, JS управляет видимостью -->
    <div class="modal__window modal__window--neumorphic">
        <button class="modal__close js-modal-close" type="button" title="Закрыть">
            <i class="fa-regular fa-xmark fa-xs"></i>
        </button>
        <h3 class="modal__title">Неоморфическое модальное окно</h3>
        <div class="modal__body">
            <p class="modal__text">Они мне надоели :(</p>
            <img class="modal__image" src="https://s3.getstickerpack.com/storage/uploads/sticker-pack/genshin-impact-tartaglia/sticker_5.png?a3d01a4a5c5f97a1d0e72b110c5cfa78" alt="Тарталья недоволен">
        </div>
        <div class="modal__footer">
            <button class="button button--neumorphic modal__action-button js-modal-action-ok" type="button">ОК</button>
            <button class="button button--neumorphic modal__action-button modal__action-button--alt js-modal-close-alt" type="button">Помучить еще..</button>
        </div>
    </div>
</div>
{% endblock modal_block %}

{% block scripts_block %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modalElement = document.querySelector('.js-modal'); // Используем JS-специфичный класс
        const openModalBtn = document.querySelector('.js-open-modal-btn');

        // Ищем кнопки закрытия только после того, как убедились, что модальное окно существует
        const closeButtons = modalElement ? modalElement.querySelectorAll('.js-modal-close, .js-modal-close-alt') : [];
        const modalOkButton = modalElement ? modalElement.querySelector('.js-modal-action-ok') : null;

        function openModal() {
            if (modalElement) {
                modalElement.classList.add('modal--open-transition'); // Класс для начала анимации
                document.body.style.overflow = 'hidden';
                // Задержка для display: flex перед началом transition
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => { // Двойной requestAnimationFrame для надежности в некоторых браузерах
                        modalElement.classList.add('modal--visible');
                    });
                });
            }
        }

        function closeModal() {
            if (modalElement) {
                modalElement.classList.remove('modal--visible');
                document.body.style.overflow = '';

                const onTransitionEnd = (event) => {
                    if (event.target === modalElement && event.propertyName === 'opacity') { // Убедимся, что событие пришло от modal и по opacity
                        modalElement.classList.remove('modal--open-transition');
                        modalElement.removeEventListener('transitionend', onTransitionEnd);
                    }
                };
                modalElement.addEventListener('transitionend', onTransitionEnd);

                // Fallback, если transitionend не сработает
                setTimeout(() => {
                    if (!modalElement.classList.contains('modal--visible')) {
                         modalElement.classList.remove('modal--open-transition');
                         if (document.body.style.overflow === 'hidden') {
                            document.body.style.overflow = '';
                         }
                    }
                }, 400); // Больше чем transition-duration
            }
        }

        if (openModalBtn) {
            openModalBtn.addEventListener('click', openModal);
        } else {
            console.warn('Кнопка для открытия модального окна (class: js-open-modal-btn) не найдена.');
        }

        closeButtons.forEach(button => {
            button.addEventListener('click', closeModal);
        });

        if (modalElement) {
            modalElement.addEventListener('click', function (event) {
                // Закрытие по клику на оверлей (event.target === this)
                if (event.target === modalElement) {
                    closeModal();
                }
            });
        } else {
            console.warn('Модальное окно (class: js-modal) не найдено.');
        }

        document.addEventListener('keydown', function (event) {
            if (event.key === "Escape" && modalElement && modalElement.classList.contains('modal--visible')) {
                closeModal();
            }
        });

        if (modalOkButton) {
            modalOkButton.addEventListener('click', function () {
                alert('Нажата кнопка "ОК" в модальном окне! Благодарность принята.');
                closeModal();
            });
        }
    });
</script>
{% endblock scripts_block %}